// backend-server/server.js
const express = require('express'); // ุงุณุชูุฑุงุฏ ููุชุจุฉ Express
const cors = require('cors');     // ุงุณุชูุฑุงุฏ ููุชุจุฉ CORS

const app = express();            // ุฅูุดุงุก ุชุทุจูู Express
const PORT = 3001;                // ุชุญุฏูุฏ ุงููููุฐ ุงูุฐู ุณูุนูู ุนููู ุงูุฎุงุฏู ุงููุญูู

// === Middleware ===
// ุงูุณูุงุญ ูุทูุจุงุช CORS (ูู ุฃู ูุตุฏุฑ ูู ูุฐู ุงูุญุงูุฉุ ููุงุณุจ ููุชุทููุฑ ุงููุญูู)
app.use(cors());
// ุงูุณูุงุญ ูู Express ุจูุฑุงุกุฉ ุจูุงูุงุช JSON ุงููุฑุณูุฉ ูู body ุงูุทูุจุงุช
app.use(express.json());

console.log("๐ง ุงูุฎุงุฏู ุงููุญูู: ุฅุนุฏุงุฏ ููุงุท ุงูุงุณุชูุจุงู (Endpoints)...");

// === ููุงุท ุงูุงุณุชูุจุงู (API Endpoints) ===

// 1. ููุทุฉ ุงุณุชูุจุงู ุทูุจุงุช ุงูุดุฑุงุก (POST /api/local/orders)
app.post('/api/local/orders', (req, res) => {
    // 'req' ูุญุชูู ุนูู ูุนูููุงุช ุงูุทูุจ ุงููุงุฏู (ุจูุง ูู ุฐูู ุงูุจูุงูุงุช ุงููุฑุณูุฉ)
    // 'res' ููุณุชุฎุฏู ูุฅุฑุณุงู ุงูุฑุฏ ุฅูู ุงููุงุฌูุฉ ุงูุฃูุงููุฉ

    console.log("\n=====================================");
    console.log("๐ [ุงูุฎุงุฏู ุงููุญูู] ุชู ุงุณุชูุจุงู ุทูุจ ุดุฑุงุก ุฌุฏูุฏ!");
    console.log("=====================================");

    try {
        // ุงูุญุตูู ุนูู ุงูุจูุงูุงุช ูู body ุงูุทูุจ (ุงูุชู ุฃุฑุณููุง fetch)
        const orderData = req.body;

        // ** ูุญุงูุงุฉ ุงููุนุงูุฌุฉ: ููุท ุทุจุงุนุฉ ุงูุจูุงูุงุช ูู ุงูุทุฑููุฉ **
        console.log("  [ุจูุงูุงุช ุงูุนููู]:");
        console.log(`    ุงูุงุณู: ${orderData.customerInfo?.fullName || 'ุบูุฑ ูุชููุฑ'}`);
        console.log(`    ุงููุงุชู: ${orderData.customerInfo?.phone || 'ุบูุฑ ูุชููุฑ'}`);
        console.log(`    ุงูุนููุงู: ${orderData.customerInfo?.address || 'ุบูุฑ ูุชููุฑ'}`);
        console.log(`    ุงููุฏููุฉ: ${orderData.customerInfo?.city || 'ุบูุฑ ูุชููุฑ'}`);
        console.log(`    ุงูููุงุญุธุงุช: ${orderData.customerInfo?.notes || 'ูุง ููุฌุฏ'}`);
        console.log("\n  [ุงูููุชุฌุงุช ุงููุทููุจุฉ]:");
        if (orderData.items && orderData.items.length > 0) {
            orderData.items.forEach((item, index) => {
                console.log(`    - ุงูููุชุฌ ${index + 1}: ${item.name} (${item.type}) | ุงูุญุฌู: ${item.size}ูู | ุงููููุฉ: ${item.quantity} | ุงูุณุนุฑ: ${item.price?.toFixed(2)} | ุงููุฌููุน: ${(item.quantity * item.price).toFixed(2)}`);
            });
        } else {
            console.log("    (ูุง ุชูุฌุฏ ููุชุฌุงุช)");
        }
        console.log(`\n  [ุงููุฌููุน ุงูููู ุงููุญุณูุจ (ุฃูุงูู)]: ${orderData.totalAmount?.toFixed(2) || 'ุบูุฑ ูุชููุฑ'}`);
        console.log(`  [ุงูุนุฑุถ ุงููุทุจู (ุฃูุงูู)]: ${orderData.offerApplied || 'ูุง ููุฌุฏ'}`);
        console.log(`  [ููุน ุงูุทูุจ (ุฃูุงูู)]: ${orderData.orderType || 'ุบูุฑ ูุญุฏุฏ'}`);


        // ** ูู ุงูุฎุงุฏู ุงูุญูููู: ููุง ุชููู ุจุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช ูุญูุธูุง ูู ูุงุนุฏุฉ ุจูุงูุงุช **

        const fakeOrderId = `local_${Date.now()}`; // ูุนุฑู ูููู ููุท ููุชุฌุฑุจุฉ
        console.log("\nโ [ุงูุฎุงุฏู ุงููุญูู] ุชูุช ูุนุงูุฌุฉ ุงูุทูุจ ุจูุฌุงุญ (ูุญุงูุงุฉ).");

        // ุฅุฑุณุงู ุฑุฏ ุฅูุฌุงุจู ุฅูู ุงููุงุฌูุฉ ุงูุฃูุงููุฉ
        res.status(200).json({
            success: true,
            message: "ุชู ุงุณุชูุงู ุทูุจู ุจูุฌุงุญ (ูู ุงูุฎุงุฏู ุงููุญูู)!",
            orderId: fakeOrderId // ููููู ุฅุนุงุฏุฉ ุฃู ุจูุงูุงุช ูููุฏุฉ
        });

    } catch (error) {
        // ูู ุญุงูุฉ ุญุฏูุซ ุฃู ุฎุทุฃ ุฃุซูุงุก ุงููุนุงูุฌุฉ
        console.error("โ [ุงูุฎุงุฏู ุงููุญูู] ุฎุทุฃ ุฃุซูุงุก ูุนุงูุฌุฉ ุทูุจ ุงูุดุฑุงุก:", error);
        res.status(500).json({ success: false, message: "ุญุฏุซ ุฎุทุฃ ูู ุงูุฎุงุฏู ุงููุญูู ุฃุซูุงุก ูุนุงูุฌุฉ ุงูุทูุจ." });
    }
    console.log("=====================================");
});

// 2. ููุทุฉ ุงุณุชูุจุงู ุงุดุชุฑุงูุงุช ุงููุดุฑุฉ (POST /api/local/subscribe)
app.post('/api/local/subscribe', (req, res) => {
    console.log("\n=====================================");
    console.log("๐ง [ุงูุฎุงุฏู ุงููุญูู] ุชู ุงุณุชูุจุงู ุทูุจ ุงุดุชุฑุงู ุฌุฏูุฏ!");
    console.log("=====================================");
    try {
        const { email, name } = req.body; // ุงูุญุตูู ุนูู ุงูุจุฑูุฏ ูุงูุงุณู

        // ** ูุญุงูุงุฉ ุงููุนุงูุฌุฉ: ููุท ุทุจุงุนุฉ ุงูุจูุงูุงุช **
        console.log(`  ุงูุจุฑูุฏ ุงูุฅููุชุฑููู: ${email || 'ุบูุฑ ูุชููุฑ'}`);
        console.log(`  ุงูุงุณู: ${name || '(ูู ูุชู ุชูููุฑู)'}`);

        // ** ูู ุงูุฎุงุฏู ุงูุญูููู: ููุง ุชุชุญูู ูู ุงูุจุฑูุฏ ูุชุญูุธู ูู ูุงุฆูุฉ ุงููุดุชุฑููู **

        console.log("โ [ุงูุฎุงุฏู ุงููุญูู] ุชูุช ูุนุงูุฌุฉ ุงูุงุดุชุฑุงู ุจูุฌุงุญ (ูุญุงูุงุฉ).");

        // ุฅุฑุณุงู ุฑุฏ ุฅูุฌุงุจู
        res.status(200).json({
            success: true,
            message: "ุชู ุชุณุฌูู ุงูุงุดุชุฑุงู ุจูุฌุงุญ (ูู ุงูุฎุงุฏู ุงููุญูู)!"
        });

    } catch (error) {
        console.error("โ [ุงูุฎุงุฏู ุงููุญูู] ุฎุทุฃ ุฃุซูุงุก ูุนุงูุฌุฉ ุงูุงุดุชุฑุงู:", error);
        res.status(500).json({ success: false, message: "ุญุฏุซ ุฎุทุฃ ูู ุงูุฎุงุฏู ุงููุญูู ุฃุซูุงุก ูุนุงูุฌุฉ ุงูุงุดุชุฑุงู." });
    }
    console.log("=====================================");
});


// === ุจุฏุก ุชุดุบูู ุงูุฎุงุฏู ===
app.listen(PORT, () => {
    console.log(`\n๐ ุงูุฎุงุฏู ุงููุญูู ูุนูู ุงูุขู ุนูู http://localhost:${PORT}`);
    console.log("   (ุงุชุฑู ูุงูุฐุฉ ุงูุทุฑููุฉ ูุฐู ููุชูุญุฉ ูุชุดุบูู ุงูุฎุงุฏู)");
    console.log("   (ุงุถุบุท CTRL+C ูุฅููุงูู)");
    console.log("\n   ุงูุฎุทูุฉ ุงูุชุงููุฉ: ุงูุชุญ ููู public/index.html ูู ูุชุตูุญู.");
});